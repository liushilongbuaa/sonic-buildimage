From aad81254c3aa88daf0d26c068a9fdcd873482205 Mon Sep 17 00:00:00 2001
From: xumia <xumia@microsoft.com>
Date: Wed, 1 Sep 2021 00:11:42 +0000
Subject: [PATCH 1/1] Support build armhf debian buster package

---
 .scripts/package-debian.sh                    | 112 ++++++++++++++++++
 Makefile                                      |  38 ++++++
 src/acms/makefile.prj                         |   6 +
 .../Debian/IaaS/acms-client/DEBIAN/changelog  |  95 +++++++++++++++
 .../Debian/IaaS/acms-client/DEBIAN/control    |   7 ++
 .../Debian/IaaS/acms-client/DEBIAN/install    |   3 +
 .../Debian/IaaS/acms-client/DEBIAN/postinst   |  44 +++++++
 .../Debian/IaaS/acms-client/DEBIAN/prerm      |  41 +++++++
 .../Debian/IaaS/acms-client_maintenance_armhf |  11 ++
 src/acms/packaging/Debian/IaaS/acms.service   |  15 +++
 src/acms/packaging/Debian/IaaS/control_armhf  |   7 ++
 .../src/secretsPayloadTests.cpp               |   3 +-
 12 files changed, 381 insertions(+), 1 deletion(-)
 create mode 100755 .scripts/package-debian.sh
 create mode 100644 Makefile
 create mode 100644 src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/changelog
 create mode 100644 src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/control
 create mode 100644 src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/install
 create mode 100755 src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/postinst
 create mode 100755 src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/prerm
 create mode 100644 src/acms/packaging/Debian/IaaS/acms-client_maintenance_armhf
 create mode 100644 src/acms/packaging/Debian/IaaS/acms.service
 create mode 100644 src/acms/packaging/Debian/IaaS/control_armhf

diff --git a/.scripts/package-debian.sh b/.scripts/package-debian.sh
new file mode 100755
index 0000000..9c16b9e
--- /dev/null
+++ b/.scripts/package-debian.sh
@@ -0,0 +1,112 @@
+#!/bin/bash
+
+export DEBIAN_FRONTEND=noninteractive
+[ -z "$BUILD_ARCH" ] && BUILD_ARCH=x86_64
+LIBNAME=${BUILD_ARCH}-linux-gnu
+if [ "$BUILD_ARCH" == "armhf" ]; then
+    LIBNAME=arm-linux-gnueabihf
+fi
+
+options=$(getopt -o '' -l release: -- "$@")
+EX=$?
+if [ "${EX}" -ne "0" ]; then
+    echo "ERROR: getopt returned error code: ${EX}"
+    exit 2
+fi
+
+eval set -- "${options}"
+while true; do
+    case "${1}" in
+    --release)
+        shift
+        RELEASE=${1}
+        ;;
+    --)
+        shift
+        break
+        ;;
+    *) 
+        echo "ERROR: Unrecognized arg '${1}'"
+        exit 3
+        ;;
+    esac
+    shift
+done
+
+echo "-------- Package ACMS for Debian ${RELEASE} ------------------------"
+# Save current working directory
+PWD=`pwd`
+pushd "${PWD}" 1>> /dev/null
+
+# Figure out location of this script. Don't assume absolute paths because paths can change between pipeline host and dev box.
+DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
+BASEDIR="$( dirname "${DIR}" )"
+echo ${BASEDIR}
+
+. "${DIR}/version.sh"
+
+major=$(echo ${PACKAGE_VERSION} | cut -d\. -f1)
+minor=$(echo ${PACKAGE_VERSION} | cut -d\. -f2)
+
+DEB_VERSION="$major.$minor"
+echo "DEB_VERSION=${DEB_VERSION}"
+
+echo '-------- Create the package location ------------------------'
+cd "${BASEDIR}/src/acms/packaging/Debian/IaaS/acms-client"
+mkdir -p "usr/bin"
+mkdir -p "usr/lib/${LIBNAME}"
+mkdir -p "lib/systemd/system"
+mkdir -p "etc/cron.daily"
+
+echo '-------- Copy files into the package location ------------------------'
+cp "${BASEDIR}/src/acms/packaging/Debian/IaaS/control_${RELEASE}" "./DEBIAN/control"
+sed -i "s/##VERSION_STRING##/${DEB_VERSION}/" "./DEBIAN/control"
+cp "${BASEDIR}/src/acms/bin.${BUILD_ARCH}/acms" "./usr/bin"
+
+EX=$?
+if [ "${EX}" -ne "0" ]; then
+    echo "Copy acms failed." 1>&2
+    exit ${EX}
+fi
+
+cp "${BASEDIR}/src/acms/bin.${BUILD_ARCH}/libIaaSBootstrapper.so.1.0.0" "./usr/lib/${LIBNAME}"
+
+EX=$?
+if [ "${EX}" -ne "0" ]; then
+    echo "Copy libIaaSBootstrapper.so.1.0.0 failed." 1>&2
+    exit ${EX}
+fi
+
+cp "${BASEDIR}/src/acms/packaging/Debian/IaaS/acms.service" "./lib/systemd/system"
+cp "${BASEDIR}/src/acms/packaging/Debian/IaaS/acms-client_maintenance_${RELEASE}" "./etc/cron.daily/acms-client_maintenance"
+
+echo "Copy Succeeded."
+
+echo '-------- Configure permissions on package files ------------------------'
+# control directory
+chmod 775 "${BASEDIR}/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN"
+# maintainer scripts
+chmod 775 "${BASEDIR}/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/postinst"
+chmod 775 "${BASEDIR}/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/prerm"
+
+echo '-------- Create Debian package ------------------------'
+cd "${BASEDIR}/src/acms/packaging/Debian/IaaS"
+dpkg-deb --build acms-client
+
+EX=$?
+if [ "${EX}" -ne "0" ]; then
+    echo "dpkg-deb failed." 1>&2
+    exit ${EX}
+fi
+
+echo '-------- Rename Debian package with version ------------------------'
+mv acms-client.deb acms-client_${DEB_VERSION}_armhf.deb
+ls acms-client_${DEB_VERSION}_armhf.deb
+
+echo "Package Debian ${RELEASE} Succeeded."
+
+# Restore working directory
+popd  1>> /dev/null
+
+# Exit with explicit 0 exit code to make sure build passes
+exit 0
diff --git a/Makefile b/Makefile
new file mode 100644
index 0000000..54c3814
--- /dev/null
+++ b/Makefile
@@ -0,0 +1,38 @@
+.ONESHELL:
+SHELL = /bin/bash
+.SHELLFLAGS += -e
+
+ACMS_CLIENT_VERSION ?= 5.0
+BOND_DEPEND_PACKAGES = libssl-dev libacl1-dev libxml2-dev uuid-dev haskell-platform haskell-stack libncurses5 libpython2.7 rapidjson-dev
+BOND_TARGETS = /usr/local/$(CONFIGURED_ARCH)/bond/lib/bond/libbond.a
+MAIN_TARGET = acms-client_$(ACMS_CLIENT_VERSION)_$(CONFIGURED_ARCH).deb
+
+$(addprefix $(DEST)/, $(MAIN_TARGET)): $(DEST)/% : $(BOND_TARGETS)
+	cd src/acms
+	make DEBIAN_FRONTEND=noninteractive BUILD_ARCH=$(CONFIGURED_ARCH)
+	cd ../../
+	RELEASE=$(CONFIGURED_ARCH) BUILD_ARCH=$(CONFIGURED_ARCH) .scripts/package-debian.sh
+	mkdir -p $(DEST)
+	cp src/acms/packaging/Debian/IaaS/acms-client_$(ACMS_CLIENT_VERSION)_$(CONFIGURED_ARCH).deb $(DEST)/
+
+$(BOND_TARGETS):
+	# Install packages before building bond
+	sudo apt-get install -y $(BOND_DEPEND_PACKAGES)
+
+	# Clone bond
+	[ ! -e bond ] && git clone -b 8.0.1 https://github.com/Microsoft/bond.git
+	mkdir -p bond/build
+	cd bond/build
+	git checkout 7038e5b3b7e501d6df459efb4c02796eea70047c
+
+	# Fix lts version compatible issue
+	sed -i "s/lts-14.4/lts-13.11/g" ../compiler/stack.yaml
+
+	# Build and install
+	cmake -DBOND_ENABLE_GRPC=FALSE -DBOND_FIND_RAPIDJSON=TRUE -DPYTHON_INCLUDE_DIR=/usr/include/python2.7 -DPYTHON_LIBRARY=usr/lib/python2.7/config-arm-linux-gnueabihf/libpython2.7.so ..
+	make
+	sudo make install
+
+	# Make symbol link for acms-client build
+	sudo mkdir -p /usr/local/$(CONFIGURED_ARCH)
+	sudo ln -sf .. /usr/local/$(CONFIGURED_ARCH)/bond
diff --git a/src/acms/makefile.prj b/src/acms/makefile.prj
index 0ee2ef2..43a5ff9 100644
--- a/src/acms/makefile.prj
+++ b/src/acms/makefile.prj
@@ -29,6 +29,12 @@ ifeq ($(BUILD_ARCH), aarch64)
     LD=aarch64-linux-gnu-ld
     OBJCOPY=aarch64-linux-gnu-objcopy
     STRIP=aarch64-linux-gnu-strip
+else ifeq ($(BUILD_ARCH), armhf)
+    AR=arm-linux-gnueabihf-ar
+    CXX=arm-linux-gnueabihf-g++
+    LD=arm-linux-gnueabihf-ld
+    OBJCOPY=arm-linux-gnueabihf-objcopy
+    STRIP=arm-linux-gnueabihf-strip
 else ifeq ($(BUILD_ARCH), x86_64)
     AR=x86_64-linux-gnu-ar
     CXX=x86_64-linux-gnu-g++ -m64 -march=core2 -mtune=core2 -msse3 -mfpmath=sse
diff --git a/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/changelog b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/changelog
new file mode 100644
index 0000000..3a7ad9f
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/changelog
@@ -0,0 +1,95 @@
+acms-client (5.14) Release; urgency=medium
+
+  * Overlake release (new bootstrap process; new SDK), commit 079f39c1243d9625f6c1a5d45bf3cbf47c8e9d04
+
+-- MAINTAINER <dsmsdev>  Tue, 13 Oct 2020 16:03:09 -0700
+
+acms-client (5.13) Release; urgency=medium
+
+  * Expose DisableCheckChainRevocation, commit 9bd16353b08dc3154d62417ce63dd3bded40d4c3
+
+-- MAINTAINER <dsmsdev>  Fri, 07 Aug 2020 16:03:09 -0700
+
+acms-client (5.12) Release; urgency=medium
+
+  * Overlake release (gRPC and SDK), commit cf35addcc1dcc9597413e5702605705514c2bc30
+
+-- MAINTAINER <dsmsdev>  Fri, 24 Jul 2020 16:03:09 -0700
+
+acms-client (5.11) Release; urgency=medium
+
+  * Enabled CRL check and fixed crashes in cert validation, commit 1b5458e0d2ca6af299a385d7955b1c5c89b0f5d7
+
+-- MAINTAINER <dsmsdev>  Thu, 16 Jul 2020 16:03:09 -0700
+
+acms-client (5.9) Release; urgency=medium
+
+  * Added -PollOnceAndExit verb, commit d098fee07698f11c51b3edf9060bb9914ca809f8
+
+-- MAINTAINER <dsmsdev>  Mon, 08 Jun 2020 19:43:02 -0700
+
+acms-client (5.8) Release; urgency=medium
+
+  * Update to fix deadlock
+
+-- MAINTAINER <dsmsdev>  Thu, 20 May 2020 12:00:00 -0800
+
+acms-client (5.7) Release; urgency=medium
+
+  * Update to fix crash in Ubuntu 16.04
+
+-- MAINTAINER <dsmsdev>  Thu, 13 Feb 2020 12:00:00 -0800
+
+acms-client (5.6) Release; urgency=medium
+
+  * Update Ubuntu xenial/bionic dependencies to include libcurl3/4
+
+-- MAINTAINER <dsmsdev>  Thu, 19 Dec 2019 12:00:00 -0800
+
+acms-client (5.5) Release; urgency=medium
+
+  * Initial release of Ubuntu 16.04 support, commit 06775dd1a7547d69067fa9448ac01376ce3c9167
+
+-- MAINTAINER <dsmsdev>  Mon, 16 Dec 2019 11:18:32 -0800
+
+acms-client (5.3) Release; urgency=medium
+
+  * Bug fixes in CA cert distribution work, commit 776f76c600c312e350353729a2fe144143de7cc7
+
+-- MAINTAINER <dsmsdev>  Thu, 05 Dec 2019 14:00:00 -0800
+
+acms-client (5.1) Release; urgency=medium
+
+  * Misc updates to CA cert distribution work, commit 2d76447f144b15534d8822db1da51083864e618a
+
+-- MAINTAINER <dsmsdev>  Wed, 20 Nov 2019 01:10:00 -0800
+
+acms-client (5.0) Release; urgency=medium
+
+  * Root cert distribution work, commit a8e7bd6f59e67836b9f6230ab21659690cbfa00b
+
+-- MAINTAINER <dsmsdev>  Mon, 11 Nov 2019 12:08:00 -0800
+
+acms-client (4.1) Release; urgency=medium
+
+  * Keeping package in sync with minor changes, commit d78d1f98ec6eebcfe0de718fd01234309cc3ab50
+
+-- MAINTAINER <dsmsdev>  Wed, 02 Oct 2019 11:56:00 -0700
+
+acms-client (4.0) Release; urgency=medium
+
+  * MSCrypt integration and acms_secrets.ini, commit 0547d7a0b462520805329aa99fef9985c90d8294
+
+-- MAINTAINER <dsmsdev>  Fri, 27 Sep 2019 16:41:00 -0700
+
+acms-client (1.1) Release; urgency=medium
+
+  * Triggering updates for any secret changes, commit 6cf544f5682a1661b96b13b7d66774346d910ee5
+
+-- MAINTAINER <dsmsdev>  Tue, 25 Jun 2019 16:03:43 -0700
+
+acms-client (1.0) Release; urgency=medium
+
+  * Initial release, commit d4daea5e70b8ba231b980ae7c4541d4fb47331ae
+
+-- MAINTAINER <dsmsdev>  Thu, 20 Jun 2019 14:40:48 -0700
diff --git a/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/control b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/control
new file mode 100644
index 0000000..dc2a11c
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/control
@@ -0,0 +1,7 @@
+Package: acms-client
+Architecture: armhf
+Priority: extra
+Depends: curl, libcurl4, libacl1, libuuid1, libxml2, gnupg
+Version: 5.0
+Description: ACMS client for dSMS
+Maintainer: dsmsdev
diff --git a/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/install b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/install
new file mode 100644
index 0000000..511cd8c
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/install
@@ -0,0 +1,3 @@
+lib/* lib
+usr/* usr
+etc/* etc
diff --git a/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/postinst b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/postinst
new file mode 100755
index 0000000..c09f982
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/postinst
@@ -0,0 +1,44 @@
+#!/usr/bin/env bash
+# postinst script for acms-client
+#
+# see: dh_installdeb(1)
+
+set -e
+
+# summary of how this script can be called:
+#        * <postinst> `configure' <most-recently-configured-version>
+#        * <old-postinst> `abort-upgrade' <new version>
+#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
+#          <new-version>
+#        * <postinst> `abort-remove'
+#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
+#          <failed-install-package> <version> `removing'
+#          <conflicting-package> <version>
+# for details, see https://www.debian.org/doc/debian-policy/ or
+# the debian-policy package
+
+
+case "$1" in
+    configure)
+    ;;
+
+    abort-upgrade|abort-remove|abort-deconfigure)
+    ;;
+
+    *)
+        echo "postinst called with unknown argument \`$1'" >&2
+        exit 1
+    ;;
+esac
+
+# dh_installdeb will replace this with shell code automatically
+# generated by other debhelper scripts.
+
+#DEBHELPER#
+
+ln -f -s /usr/lib/arm-linux-gnueabihf/libIaaSBootstrapper.so.1.0.0 /usr/lib/arm-linux-gnueabihf/libIaaSBootstrapper.so.1
+#chmod +x /etc/cron.daily/acms-client_maintenance
+#systemctl enable --now acms.service
+
+#/usr/bin/acms -Bootstrap -Dependant client -BaseDirPath /var/opt/msft/ -Event pkginstall
+exit 0
diff --git a/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/prerm b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/prerm
new file mode 100755
index 0000000..3909695
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms-client/DEBIAN/prerm
@@ -0,0 +1,41 @@
+#!/usr/bin/env bash
+# prerm script for acms-client
+#
+# see: dh_installdeb(1)
+
+set -e
+
+# summary of how this script can be called:
+#        * <prerm> `remove'
+#        * <old-prerm> `upgrade' <new-version>
+#        * <new-prerm> `failed-upgrade' <old-version>
+#        * <conflictor's-prerm> `remove' `in-favour' <package> <new-version>
+#        * <deconfigured's-prerm> `deconfigure' `in-favour'
+#          <package-being-installed> <version> `removing'
+#          <conflicting-package> <version>
+# for details, see https://www.debian.org/doc/debian-policy/ or
+# the debian-policy package
+
+
+case "$1" in
+    remove|upgrade|deconfigure)
+    ;;
+
+    failed-upgrade)
+    ;;
+
+    *)
+        echo "prerm called with unknown argument \`$1'" >&2
+        exit 1
+    ;;
+esac
+
+# dh_installdeb will replace this with shell code automatically
+# generated by other debhelper scripts.
+
+#DEBHELPER#
+
+systemctl disable --now acms.service
+rm -f /usr/lib/arm-linux-gnueabihf/libIaaSBootstrapper.so.1
+
+exit 0
diff --git a/src/acms/packaging/Debian/IaaS/acms-client_maintenance_armhf b/src/acms/packaging/Debian/IaaS/acms-client_maintenance_armhf
new file mode 100644
index 0000000..722609f
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms-client_maintenance_armhf
@@ -0,0 +1,11 @@
+#!/bin/sh
+set -e
+mkdir -p /var/opt/msft/acms
+#/bin/systemctl stop acms
+# The armhf acms is not ready for now
+#/bin/echo "deb [arch=armhf] https://packages.microsoft.com/debian/10/prod buster main" |  tee /etc/apt/sources.list.d/msftDebianBusterProd.list
+#/usr/bin/apt-get update -o Dir::Etc::sourcelist="sources.list.d/msftDebianBusterProd.list" -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0" >> /var/opt/msft/acms/update.log 2>&1
+#/usr/bin/apt-get --only-upgrade install acms-client -y >> /var/opt/msft/acms/update.log 2>&1
+#/bin/rm -f /etc/apt/sources.list.d/msftUbuntu1804Prod.list
+#/bin/systemctl start acms
+/bin/echo "Checked for acms-client update at $(/bin/date)" >> /var/opt/msft/acms/update.log 2>&1
diff --git a/src/acms/packaging/Debian/IaaS/acms.service b/src/acms/packaging/Debian/IaaS/acms.service
new file mode 100644
index 0000000..41a1cfb
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/acms.service
@@ -0,0 +1,15 @@
+[Unit]
+Description=Azure Credentials Management Service
+After=network-online.target rsyslog.service
+Wants=network-online.target rsyslog.service
+
+[Service]
+Type=simple
+RestartSec=10
+TimeoutStopSec=1
+Restart=on-success
+WorkingDirectory=/usr/bin
+ExecStart=/usr/bin/acms -Start -BaseDirPath /var/opt/msft/
+
+[Install]
+WantedBy=multi-user.target
diff --git a/src/acms/packaging/Debian/IaaS/control_armhf b/src/acms/packaging/Debian/IaaS/control_armhf
new file mode 100644
index 0000000..54c1a28
--- /dev/null
+++ b/src/acms/packaging/Debian/IaaS/control_armhf
@@ -0,0 +1,7 @@
+Package: acms-client
+Architecture: armhf
+Priority: extra
+Depends: curl, libcurl4, libacl1, libuuid1, libxml2, gnupg
+Version: ##VERSION_STRING##
+Description: ACMS client for dSMS
+Maintainer: dsmsdev
diff --git a/src/acms/tests/secretsPayloadTests/src/secretsPayloadTests.cpp b/src/acms/tests/secretsPayloadTests/src/secretsPayloadTests.cpp
index fa9d732..0c02b23 100644
--- a/src/acms/tests/secretsPayloadTests/src/secretsPayloadTests.cpp
+++ b/src/acms/tests/secretsPayloadTests/src/secretsPayloadTests.cpp
@@ -18,6 +18,7 @@
 #include "SecureBlob.h"
 
 #include "gtest/gtest.h"
+#pragma GCC diagnostic ignored "-Wconversion"
 
 namespace
 {
@@ -422,4 +423,4 @@ namespace
         // restore write permissions
         ASSERT_EQ(0, chmod(dirpath.c_str(), S_IRWXU|S_IRWXG|S_IRWXO));
     }
-}
\ No newline at end of file
+}
-- 
2.17.1

