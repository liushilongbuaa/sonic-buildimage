From 1de28e1bfa9b54d64fe57fb42c06c20ef219ae8c Mon Sep 17 00:00:00 2001
From: Pavel Shirshov <pavelsh@microsoft.com>
Date: Thu, 30 Jul 2020 09:01:36 -0700
Subject: [PATCH] Stopping all BGP SLB neighbors before FastReboot

---
 scripts/fast-reboot | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/scripts/fast-reboot b/scripts/fast-reboot
index e884dee..2e8f4b6 100755
--- a/scripts/fast-reboot
+++ b/scripts/fast-reboot
@@ -373,6 +373,23 @@ case "$REBOOT_TYPE" in
         ;;
 esac
 
+# Stopping all SLB neighbors if they're presented
+if [[ "$REBOOT_TYPE" = "fast-reboot" ]]; then
+    debug "Stopping all SLB neighbors if they are presented"
+    PASSIVE_BGP_NEIGHBORS=$(sonic-cfggen -d -v "BGP_PEER_RANGE | list")
+    case "$PASSIVE_BGP_NEIGHBORS" in
+        *BGPSLBPassive*)
+        RUNNING_CONFIG=$(vtysh -c "show running")
+        if grep -q "neighbor BGPSLBPassive peer-group" <<< "$RUNNING_CONFIG"; then
+            ASN=$(sonic-cfggen -d -v "DEVICE_METADATA['localhost']['bgp_asn']")
+            vtysh -c "configure terminal" -c "router bgp ${ASN}" -c "neighbor BGPSLBPassive shutdown"
+        fi
+        ;;
+    *)
+        ;;
+    esac
+fi
+
 unload_kernel
 
 setup_reboot_variables
-- 
2.17.1.windows.2

