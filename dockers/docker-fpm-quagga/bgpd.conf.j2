!
{% block banner %}
! =========== Managed by sonic-cfggen DO NOT edit manually! ====================
! generated by templates/quagga/bgpd.conf.j2 with config DB data
! file: bgpd.conf
!
{% endblock banner %}
!
{% block system_init %}
hostname {{ DEVICE_METADATA['localhost']['hostname'] }}
password zebra
log syslog informational
log facility local4
! enable password {# {{ en_passwd }} TODO: param needed #}
{% endblock system_init %}
!
{% if 'bgp_asn' in DEVICE_METADATA['localhost'] %}
{% block bgp_init %}
!
! bgp multiple-instance
!
{% if DEVICE_METADATA['localhost']['type'] == 'LeafRouter' %}
ip community-list standard LEAK_COMMUNITY permit 8075:10400
ip community-list standard UPSTREAM_PREFIX permit 8075:54000
ip community-list standard TYCOON_ER_COMMUNITY permit 12076:10450
ip community-list standard TYCOON_ER_COMMUNITY permit 8075:10451
!
ip prefix-list DEFAULT_IPV4 permit 0.0.0.0/0
ip prefix-list IPV4_18_OR_LONGER permit 0.0.0.0/0 ge 18
ip prefix-list IPV4_30_OR_LONGER permit 0.0.0.0/0 ge 30
!
ipv6 prefix-list DEFAULT_IPV6 permit ::/0
ipv6 prefix-list IPV6_64_ONLY permit ::/0 ge 64 le 64
!
route-map FROM_TIER0_V4 permit 10
 match community UPSTREAM_PREFIX
 match ip address prefix-list DEFAULT_IPV4
!
route-map FROM_TIER0_V4 permit 20
 match community LEAK_COMMUNITY
 match ip address prefix-list IPV4_18_OR_LONGER
 set comm-list LEAK_COMMUNITY delete
!
route-map FROM_TIER0_V4 permit 30
 match ip address prefix-list IPV4_18_OR_LONGER
!
route-map FROM_TIER0_V4 deny 1000
!
route-map FROM_TIER0_V6 permit 10
  match community UPSTREAM_PREFIX
  match ipv6 address prefix-list DEFAULT_IPV6
!
route-map FROM_TIER0_V6 permit 20
  match community LEAK_COMMUNITY
  match ipv6 address prefix-list IPV6_64_ONLY
  set comm-list LEAK_COMMUNITY delete
!
route-map FROM_TIER0_V6 permit 30
  match ipv6 address prefix-list IPV6_64_ONLY
!
route-map FROM_TIER0_V6 deny 1000
!
route-map FROM_TIER2_V4 permit 10
 set community 8075:54000 additive
!
route-map FROM_TIER2_V6 permit 10
 set community 8075:54000 additive
!
route-map TO_TIER0_V4 permit 10
 match community UPSTREAM_PREFIX
 match ip address prefix-list DEFAULT_IPV4
!
route-map TO_TIER0_V4 permit 20
 match community LEAK_COMMUNITY
!
route-map TO_TIER0_V4 permit 30
 match community UPSTREAM_PREFIX
 set community no-export additive
!
route-map TO_TIER0_V4 permit 1000
!
route-map TO_TIER0_V6 permit 10
 match community UPSTREAM_PREFIX
 match ipv6 address prefix-list DEFAULT_IPV6
!
route-map TO_TIER0_V6 permit 20
 match community LEAK_COMMUNITY
!
route-map TO_TIER0_V6 permit 30
 match community UPSTREAM_PREFIX
 set community no-export additive
!
route-map TO_TIER0_V6 permit 1000
!
route-map TO_TIER2_V4 deny 5
 match community UPSTREAM_PREFIX
!
route-map TO_TIER2_V4 permit 10
!
route-map TO_TIER2_V6 deny 5
 match community UPSTREAM_PREFIX
!
route-map TO_TIER2_V6 permit 10
!
{# TYCOON Route-Map #}
!
route-map TO_TYCOON_ER_V4 permit 100
  match ip address prefix-list DEFAULT_IPV4
!
route-map TO_TYCOON_ER_V4 deny 10000
!
route-map FROM_TYCOON_ER_V4 deny 100
  match ip address prefix-list DEFAULT_IPV4
!
route-map FROM_TYCOON_ER_V4 permit 200
  match community TYCOON_ER_COMMUNITY
  match ip address prefix-list IPV4_30_OR_LONGER
!
route-map FROM_TYCOON_ER_V4 deny 10000
!
route-map TO_TYCOON_ER_V6 permit 100
  match ipv6 address prefix-list DEFAULT_IPV6
!
route-map TO_TYCOON_ER_V6 deny 10000
!
route-map FROM_TYCOON_ER_V6 deny 100
  match ipv6 address prefix-list DEFAULT_IPV6
!
route-map FROM_TYCOON_ER_V6 permit 200
  match community TYCOON_ER_COMMUNITY
  match ipv6 address prefix-list IPV6_64_ONLY
!
route-map FROM_TYCOON_ER_V6 deny 10000
!
{% endif %}
route-map FROM_BGP_SPEAKER_V4 permit 10
!
route-map TO_BGP_SPEAKER_V4 deny 10
!
router bgp {{ DEVICE_METADATA['localhost']['bgp_asn'] }}
  bgp log-neighbor-changes
  bgp bestpath as-path multipath-relax
  no bgp default ipv4-unicast
  bgp graceful-restart restart-time 240
  bgp graceful-restart
{% for (name, prefix) in LOOPBACK_INTERFACE|pfx_filter %}
{% if prefix | ipv4 and name == 'Loopback0' %}
  bgp router-id {{ prefix | ip }}
{% endif %}
{% endfor %}
{# advertise loopback #}
{% for (name, prefix) in LOOPBACK_INTERFACE|pfx_filter %}
{% if prefix | ipv4 and name == 'Loopback0' %}
  network {{ prefix | ip }}/32
{% elif prefix | ipv6 and name == 'Loopback0' %}
  address-family ipv6
    network {{ prefix | ip }}/64
  exit-address-family
{% endif %}
{% endfor %}
{% endblock bgp_init %}
{% endif %}
{% block vlan_advertisement %}
{% for (name, prefix) in VLAN_INTERFACE|pfx_filter %}
{% if prefix | ipv4 %}
  network {{ prefix }}
{% elif prefix | ipv6 %}
  address-family ipv6
   network {{ prefix }}
  exit-address-family
{% endif %}
{% endfor %}
{% endblock vlan_advertisement %}
{% block bgp_sessions %}
{% for neighbor_addr, bgp_session in BGP_NEIGHBOR.items() %}
{% if bgp_session['asn'] | int != 0 %}
  neighbor {{ neighbor_addr }} remote-as {{ bgp_session['asn'] }}
  neighbor {{ neighbor_addr }} description {{ bgp_session['name'] }}
{# set the bgp neighbor timers if they have not default values #}
{% if     (bgp_session['keepalive'] is defined and bgp_session['keepalive'] | int != 60)
      or  (bgp_session['holdtime'] is defined  and bgp_session['holdtime']  | int != 180) %}
  neighbor {{ neighbor_addr }} timers {{ bgp_session['keepalive'] }} {{ bgp_session['holdtime'] }}
{% endif %}
{% if (DEVICE_METADATA['localhost']['type'] == 'LeafRouter' and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter') or DEVICE_METADATA['localhost']['type'] == 'ToRRouter' %}
  neighbor {{ neighbor_addr }} allowas-in 1
{% endif %}
{% if 'admin_status' in bgp_session and bgp_session['admin_status'] == 'down' or 'admin_status' not in bgp_session and 'default_bgp_status' in DEVICE_METADATA['localhost'] and DEVICE_METADATA['localhost']['default_bgp_status'] == 'down' and DEVICE_METADATA.localhost.type != 'ToRRouter' %}
  neighbor {{ neighbor_addr }} shutdown
{% endif %}
{% if neighbor_addr | ipv4 %}
  address-family ipv4
{% if (DEVICE_METADATA['localhost']['type'] == 'LeafRouter' and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter') or DEVICE_METADATA['localhost']['type'] == 'ToRRouter' %}
    neighbor {{ neighbor_addr }} allowas-in 1
{% endif %}
    neighbor {{ neighbor_addr }} activate
    neighbor {{ neighbor_addr }} soft-reconfiguration inbound
{% if DEVICE_METADATA['localhost']['type'] == 'ToRRouter' %}
    neighbor {{ neighbor_addr }} maximum-prefix 12000 90 warning-only
{% endif %}
    maximum-paths 64
{% if DEVICE_METADATA['localhost']['type'] == 'LeafRouter' %}
 {%- if DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter'
  and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['deployment_id'] is defined
  and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['deployment_id'] == '26' %}
    neighbor {{ neighbor_addr }} route-map FROM_TYCOON_ER_V4 in
    neighbor {{ neighbor_addr }} route-map TO_TYCOON__ER_V4 out
    neighbor {{ neighbor_addr }} send-community
    neighbor {{ neighbor_addr }} maximum-prefix 6 60
{% elif DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter' %}
    neighbor {{ neighbor_addr }} route-map FROM_TIER0_V4 in
    neighbor {{ neighbor_addr }} route-map TO_TIER0_V4 out
    neighbor {{ neighbor_addr }} send-community
    neighbor {{ neighbor_addr }} maximum-prefix 12000 90 warning-only
{% endif %}
 {%- if DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'SpineRouter' %}
    neighbor {{ neighbor_addr }} route-map FROM_TIER2_V4 in
    neighbor {{ neighbor_addr }} route-map TO_TIER2_V4 out
    neighbor {{ neighbor_addr }} send-community
    neighbor {{ neighbor_addr }} maximum-prefix 12000 90 warning-only
{% endif %}
{% endif %}
  exit-address-family
{% endif %}
{% if neighbor_addr | ipv6 %}
  address-family ipv6
{% if (DEVICE_METADATA['localhost']['type'] == 'LeafRouter' and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter') or DEVICE_METADATA['localhost']['type'] == 'ToRRouter' %}
    neighbor {{ neighbor_addr }} allowas-in 1
{% endif %}
    neighbor {{ neighbor_addr }} activate
    neighbor {{ neighbor_addr }} soft-reconfiguration inbound
{% if DEVICE_METADATA['localhost']['type'] == 'ToRRouter' %}
    neighbor {{ neighbor_addr }} maximum-prefix 8000 90 warning-only
{% endif %}
    maximum-paths 64
{% if DEVICE_METADATA['localhost']['type'] == 'LeafRouter' %}
 {%- if DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter'
  and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['deployment_id'] is defined
  and DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['deployment_id'] == '26' %}
    neighbor {{ neighbor_addr }} route-map FROM_TYCOON_ER_V6 in
    neighbor {{ neighbor_addr }} route-map TO_TYCOON__ER_V6 out
    neighbor {{ neighbor_addr }} send-community
    neighbor {{ neighbor_addr }} maximum-prefix 4 50
{% elif DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'ToRRouter' %}
    neighbor {{ neighbor_addr }} route-map FROM_TIER0_V6 in
    neighbor {{ neighbor_addr }} route-map TO_TIER0_V6 out
    neighbor {{ neighbor_addr }} send-community
    neighbor {{ neighbor_addr }} maximum-prefix 8000 90 warning-only
{% endif %}
 {%- if DEVICE_NEIGHBOR_METADATA[bgp_session['name']]['type'] == 'SpineRouter' %}
    neighbor {{ neighbor_addr }} route-map FROM_TIER2_V6 in
    neighbor {{ neighbor_addr }} route-map TO_TIER2_V6 out
    neighbor {{ neighbor_addr }} send-community
    neighbor {{ neighbor_addr }} maximum-prefix 8000 90 warning-only
{% endif %}
{% endif %}
  exit-address-family
{% endif %}
{% endif %}
{% endfor %}
{% endblock bgp_sessions %}
{% block bgp_peers_with_range %}
{% if BGP_PEER_RANGE %}
{% for bgp_peer in BGP_PEER_RANGE.values() %}
  neighbor {{ bgp_peer['name'] }} peer-group
  neighbor {{ bgp_peer['name'] }} passive
{% if bgp_peer['peer_asn'] is defined %}
  neighbor {{ bgp_peer['name'] }} remote-as {{ bgp_peer['peer_asn'] }}
{% else %}
  neighbor {{ bgp_peer['name'] }} remote-as {{ constants.deployment_id_asn_map[DEVICE_METADATA['localhost']['deployment_id']] }}
{% endif %}
  neighbor {{ bgp_peer['name'] }} ebgp-multihop 255
  neighbor {{ bgp_peer['name'] }} soft-reconfiguration inbound
{% if bgp_peer['src_address'] is defined %}
  neighbor {{ bgp_peer['name'] }} update-source {{ bgp_peer['src_address'] | ip }}
{% else %}
{% for (name, prefix) in LOOPBACK_INTERFACE|pfx_filter %}
{% if name == 'Loopback1' %}
  neighbor {{ bgp_peer['name'] }} update-source {{ prefix | ip }}
{% endif %}
{% endfor %}
{% endif %}
  neighbor {{ bgp_peer['name'] }} route-map FROM_BGP_SPEAKER_V4 in
  neighbor {{ bgp_peer['name'] }} route-map TO_BGP_SPEAKER_V4 out
{% for ip_range in bgp_peer['ip_range'] %}
  bgp listen range {{ip_range}} peer-group {{ bgp_peer['name'] }}
{% endfor %}
  address-family ipv4
    neighbor {{ bgp_peer['name'] }} activate
    maximum-paths 64
  exit-address-family
  address-family ipv6
    neighbor {{ bgp_peer['name'] }} activate
    maximum-paths 64
  exit-address-family
{% endfor %}
{% endif %}
{% endblock bgp_peers_with_range %}
!
{% if 'bgp_asn' in DEVICE_METADATA['localhost'] %}
maximum-paths 64
!
route-map ISOLATE permit 10
set as-path prepend {{ DEVICE_METADATA['localhost']['bgp_asn'] }}
{% endif %}
!
