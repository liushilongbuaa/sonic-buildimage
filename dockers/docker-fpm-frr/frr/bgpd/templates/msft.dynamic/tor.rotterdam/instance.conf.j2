!
! template: bgpd/templates/msft.dynamic/tor.rotterdam/instance.conf.j2
!
{% from "common/functions.conf.j2" import get_ipv4_loopback_address %}
!
  neighbor {{ bgp_session['name'] }} peer-group
  neighbor {{ bgp_session['name'] }} passive
  neighbor {{ bgp_session['name'] }} ebgp-multihop 255
!
{% if bgp_session['peer_asn'] is defined %}
  neighbor {{ bgp_session['name'] }} remote-as {{ bgp_session['peer_asn'] }}
{% else %}
  neighbor {{ bgp_session['name'] }} remote-as {{ constants.deployment_id_asn_map[CONFIG_DB__DEVICE_METADATA['localhost']['deployment_id']] }}
{% endif %}
!
{# FIXME: bgp_session['ip_range'] check the type #}
{# FIXME: Extract it! This is only instance #}
{% for ip_range in bgp_session['ip_range'].split(',') %}
  bgp listen range {{ ip_range }} peer-group {{ bgp_session['name'] }}
{% endfor %}
!
{% if bgp_session['src_address'] is defined %}
  neighbor {{ bgp_session['name'] }} update-source {{ bgp_session['src_address'] | ip }}
{% else %}
  neighbor {{ bgp_session['name'] }} update-source {{ get_ipv4_loopback_address(CONFIG_DB__LOOPBACK_INTERFACE, "Loopback1") | ip }}
{% endif %}
!
{% if bgp_session['ip_range'].split(',')[0] | ipv4 %}
  address-family ipv4
    neighbor {{ bgp_session['name'] }} activate
    neighbor {{ bgp_session['name'] }} maximum-prefix 5 79
    neighbor {{ bgp_session['name'] }} route-map FROM_SDN_APPLIANCE_V4 in
    neighbor {{ bgp_session['name'] }} route-map TO_SDN_APPLIANCE_V4 out
    neighbor {{ bgp_session['name'] }} soft-reconfiguration inbound
  exit-address-family
{% endif %}

{% if bgp_session['ip_range'].split(',')[0] | ipv6 %}
  address-family ipv6
    neighbor {{ bgp_session['name'] }} activate
    neighbor {{ bgp_session['name'] }} maximum-prefix 5 79
    neighbor {{ bgp_session['name'] }} route-map FROM_SDN_APPLIANCE_V6 in
    neighbor {{ bgp_session['name'] }} route-map TO_SDN_APPLIANCE_V6 out
    neighbor {{ bgp_session['name'] }} soft-reconfiguration inbound
  exit-address-family
{% endif %}
!
! end of template: bgpd/templates/msft.dynamic/tor.rotterdam/instance.conf.j2
!
